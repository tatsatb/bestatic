name: Build Linux Installer

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.0.31)'
        required: true
        type: string
      create_release:
        description: 'Create/Update GitHub Release'
        required: true
        type: boolean
        default: false
      release_type:
        description: 'Release type'
        required: false
        type: choice
        options:
          - latest
          - prerelease
        default: latest

jobs:
  build-linux-installer:
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            arch: x86_64
          - os: ubuntu-22.04-arm
            arch: aarch64
    
    steps:
      - name: Prepare version
        id: version
        shell: bash
        run: |
          VERSION="${{ github.event.inputs.version }}"
          VERSION_NUMBER="${VERSION#v}"
          echo "VERSION=$VERSION_NUMBER" >> $GITHUB_OUTPUT
          echo "Cleaned version: $VERSION_NUMBER"
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git describe
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .
          pip install pyinstaller
      
      - name: Build with PyInstaller
        run: |
          MAGIC_FILE=$(find /usr/lib/file /usr/share/file /usr/share/misc -name magic.mgc 2>/dev/null | head -n 1)
          
          if [ -z "$MAGIC_FILE" ]; then
            echo "Error: Could not find magic.mgc on build system"
            exit 1
          fi

          echo "Bundling magic database from: $MAGIC_FILE"
          
          cd bestatic
          pyinstaller \
            --add-data "$MAGIC_FILE:." \
            --collect-all bestatic \
            --recursive-copy-metadata Bestatic \
            --collect-all customblocks \
            --hidden-import yamlns \
            --collect-all markdown \
            --recursive-copy-metadata mkdocs-material \
            --recursive-copy-metadata mkdocs \
            --collect-all mkdocs \
            --collect-all material \
            --collect-all bs4 \
            --recursive-copy-metadata beautifulsoup4 \
            --collect-all pymdown-extensions \
            --recursive-copy-metadata pymdown-extensions \
            --collect-all pygments \
            --recursive-copy-metadata pygments \
            --recursive-copy-metadata mkdocs-material-extensions \
            --collect-all jinja2 \
            --recursive-copy-metadata jinja2 \
            --collect-all watchdog \
            --recursive-copy-metadata watchdog \
            --collect-all pyyaml \
            --recursive-copy-metadata pyyaml \
            --collect-all chardet \
            --recursive-copy-metadata chardet \
            --collect-all markdown_include \
            --recursive-copy-metadata markdown_include \
            --collect-all tomli \
            --recursive-copy-metadata tomli \
            --collect-all pillow \
            --recursive-copy-metadata pillow \
            --collect-all soupsieve \
            --recursive-copy-metadata soupsieve \
            --collect-all setuptools \
            --recursive-copy-metadata setuptools \
            --collect-all magic \
            --recursive-copy-metadata python-magic \
            --onedir \
            --console \
            --noconfirm \
            --name bestatic \
            bestatic.py
      
      - name: Verify build
        run: |
          if [ -f "bestatic/dist/bestatic/bestatic" ]; then
            echo "✓ Build successful: bestatic executable found"
            ls -lh bestatic/dist/bestatic/
          else
            echo "✗ Build failed: bestatic executable not found"
            exit 1
          fi
      
      - name: Prepare package structure
        run: |
          VERSION_NUMBER="${{ steps.version.outputs.VERSION }}"
          
          echo "Creating package structure..."
          
          # Create package directory
          PKG_DIR="bestatic-${VERSION_NUMBER}-linux-${{ matrix.arch }}"
          mkdir -p "$PKG_DIR"
          mkdir -p installer_output
          
          # Copy application files
          cp -R bestatic/dist/bestatic/* "$PKG_DIR/"
          
          # Create install.sh script
          cat > "$PKG_DIR/install.sh" << 'EOF'
          #!/bin/bash
          set -e
          
          # Colors for output
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          NC='\033[0m' # No Color
          
          echo -e "${GREEN}Bestatic Linux Installer${NC}"
          echo "================================"
          echo ""
          
          # Get the directory where the script is located
          SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
          INSTALL_DIR="/opt/bestatic"
          BIN_LINK="/usr/local/bin/bestatic"
          
          # Check if running as root
          if [ "$EUID" -ne 0 ]; then 
              echo -e "${YELLOW}This script requires root privileges.${NC}"
              echo "Please run with sudo: sudo ./install.sh"
              exit 1
          fi
          
          echo "Installing Bestatic..."
          
          # Create installation directory
          echo "→ Creating installation directory: $INSTALL_DIR"
          mkdir -p "$INSTALL_DIR"
          
          # Copy files
          echo "→ Copying files..."
          cp -R "$SCRIPT_DIR"/* "$INSTALL_DIR/"
          chmod +x "$INSTALL_DIR/bestatic"
          
          # Create symlink
          echo "→ Creating symlink in /usr/local/bin..."
          ln -sf "$INSTALL_DIR/bestatic" "$BIN_LINK"
          
          echo ""
          echo -e "${GREEN}✓ Installation complete!${NC}"
          echo ""
          echo "Bestatic has been installed to: $INSTALL_DIR"
          echo "You can now run 'bestatic' from anywhere in the terminal."
          echo ""
          echo "To uninstall, run: sudo $INSTALL_DIR/uninstall.sh"
          echo ""
          EOF
          
          chmod +x "$PKG_DIR/install.sh"
          
          # Create uninstall.sh script
          cat > "$PKG_DIR/uninstall.sh" << 'EOF'
          #!/bin/bash
          set -e
          
          # Colors for output
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          NC='\033[0m' # No Color
          
          echo -e "${YELLOW}Bestatic Linux Uninstaller${NC}"
          echo "================================"
          echo ""
          
          INSTALL_DIR="/opt/bestatic"
          BIN_LINK="/usr/local/bin/bestatic"
          
          # Check if running as root
          if [ "$EUID" -ne 0 ]; then 
              echo -e "${RED}This script requires root privileges.${NC}"
              echo "Please run with sudo: sudo ./uninstall.sh"
              exit 1
          fi
          
          echo "Uninstalling Bestatic..."
          
          # Remove symlink
          if [ -L "$BIN_LINK" ]; then
              echo "→ Removing symlink: $BIN_LINK"
              rm "$BIN_LINK"
          fi
          
          # Remove installation directory
          if [ -d "$INSTALL_DIR" ]; then
              echo "→ Removing installation directory: $INSTALL_DIR"
              rm -rf "$INSTALL_DIR"
          fi
          
          echo ""
          echo -e "${GREEN}✓ Uninstallation complete!${NC}"
          echo ""
          echo "Bestatic has been removed from your system."
          echo ""
          EOF
          
          chmod +x "$PKG_DIR/uninstall.sh"
          
          # Create README - using simple text without YAML-problematic formatting
          cat > "$PKG_DIR/README.txt" << 'EOF'
          Bestatic - Linux Distribution
          ================================================
          
          INSTALLATION INSTRUCTIONS
          
          1. Extract this archive
          2. Navigate to the extracted directory
          3. Run the installation script with root privileges:
             sudo ./install.sh
          
          This will:
          - Install Bestatic to /opt/bestatic
          - Create a symlink in /usr/local/bin/bestatic
          - Add bestatic to your PATH automatically
          
          4. Verify the installation:
             bestatic --help
          
          UNINSTALLATION
          
          To remove Bestatic from your system:
             sudo /opt/bestatic/uninstall.sh
          
          Or if you still have the extracted directory:
             sudo ./uninstall.sh
          
          MANUAL INSTALLATION (Alternative)
          
          If you prefer not to use the install script:
          1. Copy the bestatic directory to your preferred location
          2. Add the directory to your PATH, or create a symlink
          
          USAGE
          
          After installation, run:
             bestatic --help
          
          For documentation, visit: https://www.bestaticpy.com
          
          SUPPORT
          
          Report issues at: https://github.com/tatbansare/bestatic/issues
          
          LICENSE
          
          See the LICENSE file for license information.
          EOF
          
          # Copy LICENSE
          cp LICENSE "$PKG_DIR/"
          
          echo "✓ Package structure created"
      
      - name: Create tarball
        run: |
          VERSION_NUMBER="${{ steps.version.outputs.VERSION }}"
          PKG_DIR="bestatic-${VERSION_NUMBER}-linux-${{ matrix.arch }}"
          
          echo "Creating tarball..."
          tar -czf "installer_output/${PKG_DIR}.tar.gz" "$PKG_DIR"
          
          echo "✓ Tarball created"
      
      - name: Verify package
        run: |
          VERSION_NUMBER="${{ steps.version.outputs.VERSION }}"
          PKG_FILE="installer_output/bestatic-${VERSION_NUMBER}-linux-${{ matrix.arch }}.tar.gz"
          
          if [ -f "$PKG_FILE" ]; then
            FILE_SIZE=$(du -h "$PKG_FILE" | cut -f1)
            echo "✓ Package created: $PKG_FILE"
            echo "  Size: $FILE_SIZE"
            
            # List contents
            echo ""
            echo "Package contents:"
            tar -tzf "$PKG_FILE" | head -20
          else
            echo "✗ Package not found at: $PKG_FILE"
            ls -la installer_output/
            exit 1
          fi
      
      - name: Upload package as artifact
        uses: actions/upload-artifact@v4
        with:
          name: bestatic-linux-installer-${{ matrix.arch }}
          path: installer_output/bestatic-*.tar.gz
          retention-days: 5
          
      - name: Generate checksums
        if: github.event.inputs.create_release == 'true'
        run: |
          VERSION_NUMBER="${{ steps.version.outputs.VERSION }}"
          PKG_FILE="installer_output/bestatic-${VERSION_NUMBER}-linux-${{ matrix.arch }}.tar.gz"
          
          SHA256=$(sha256sum "$PKG_FILE" | cut -d' ' -f1)
          
          echo "SHA256 Checksum:"
          echo "  $SHA256"
          
          # Save to file
          CHECKSUM_FILE="${PKG_FILE}.sha256"
          echo "$SHA256  $(basename $PKG_FILE)" > "$CHECKSUM_FILE"
          
          echo "✓ Checksum saved to: $CHECKSUM_FILE"
      
      - name: Create or Update Release
        if: github.event.inputs.create_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          draft: true
          prerelease: ${{ github.event.inputs.release_type == 'prerelease' }}
          files: |
            installer_output/bestatic-*.tar.gz
            installer_output/bestatic-*.tar.gz.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
